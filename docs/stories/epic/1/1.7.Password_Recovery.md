# Story 1.7: Password Recovery

## Status
Done

## Story
**As a** user who has forgotten my password,
**I want** to request a password reset link via email,
**so that** I can regain access to my account.

## Acceptance Criteria
1.  A "Forgot Password?" link is available on the login page.
2.  Clicking the link takes the user to a page where they can enter their email address.
3.  Submitting the email triggers a backend process to send a password reset email if the user exists.
4.  The email contains a unique, time-limited link to a password reset page.
5.  The password reset page allows the user to enter and confirm a new password.
6.  The new password must meet the application's security requirements.
7.  Submitting the new password updates the user's password in the database.
8.  The reset link/token is invalidated after use or expiration.

## Tasks / Subtasks
- [x] Task 1 (Frontend - AC: 1, 2): Create the "Forgot Password" page.
    - [x] Subtask 1.1: Add a "Forgot Password?" link to the `LoginPage` component.
    - [x] Subtask 1.2: Create a `ForgotPasswordPage` component with a form to enter an email address.
    - [x] Subtask 1.3: On submission, call a `forgotPassword` method in the `authService`.
- [x] Task 2 (Frontend - AC: 4, 5, 6): Create the "Reset Password" page.
    - [x] Subtask 2.1: Create a `ResetPasswordPage` component that accepts a token from the URL.
    - [x] Subtask 2.2: The page should have a form for entering and confirming a new password.
    - [x] Subtask 2.3: On submission, call a `resetPassword` method in the `authService` with the token and new password.
- [x] Task 3 (Backend - AC: 3, 4): Implement the forgot password endpoint.
    - [x] Subtask 3.1: Create a `POST /api/auth/forgot-password` endpoint in `AuthController`.
    - [x] Subtask 3.2: In `AuthService`, implement logic to generate a secure, time-limited (e.g., 1 hour) password reset token.
    - [x] Subtask 3.3: Store the token and its expiry, associated with the user.
    - [x] Subtask 3.4: Integrate an email service to send the password reset link to the user's email.
- [x] Task 4 (Backend - AC: 5, 6, 7, 8): Implement the reset password endpoint.
    - [x] Subtask 4.1: Create a `POST /api/auth/reset-password` endpoint in `AuthController`.
    - [x] Subtask 4.2: Create a `ResetPasswordRequest` DTO accepting `token` and `newPassword`.
    - [x] Subtask 4.3: In `AuthService`, validate the token, update the user's password (hashed), and invalidate the token.
- [x] Task 5: Add integration tests for the password recovery flow.

## Dev Agent Record

### File List
- `frontend/src/pages/LoginPage.tsx` (Modified)
- `frontend/src/pages/ForgotPasswordPage.tsx` (Created)
- `frontend/src/pages/ResetPasswordPage.tsx` (Created)
- `frontend/src/router/AppRouter.tsx` (Modified)
- `frontend/src/services/authService.ts` (Modified)
- `backend/src/main/java/com/taskflow/dto/ForgotPasswordRequest.java` (Created)
- `backend/src/main/java/com/taskflow/dto/ResetPasswordRequest.java` (Created)
- `backend/src/main/java/com/taskflow/controller/AuthController.java` (Modified)
- `backend/src/main/java/com/taskflow/model/User.java` (Modified)
- `backend/src/main/java/com/taskflow/repository/UserRepository.java` (Modified)
- `backend/src/main/java/com/taskflow/service/AuthService.java` (Modified)
- `backend/src/test/java/com/taskflow/controller/AuthControllerIntegrationTest.java` (Modified)

## Dev Notes

### Frontend
- **Routing:** Add new routes for `/forgot-password` and `/reset-password/:token`.
- **UI:** The new pages should align with the existing UI style.
- **Error Handling:** Provide clear feedback to the user (e.g., "If an account with that email exists, a reset link has been sent.").

### Backend
- **Email Service:** An email service (e.g., SendGrid, Mailgun, or a mock for local dev) needs to be configured.
- **Security:**
    - The password reset token must be securely generated and stored.
    - The token must have a short expiration time to minimize risk.
    - The token must be invalidated immediately after use.
- **Configuration:** The frontend URL for the reset link should be configurable.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-06 | 1.0 | Initial draft | John (Product Manager) |

## QA Results
### QA Review for Story 1.7: Password Recovery

#### 1. Requirements Traceability

| Acceptance Criteria | Status | Notes |
| :--- | :--- | :--- |
| 1. "Forgot Password?" link on login page. | ✅ **PASS** | Implemented in `LoginPage.tsx`. |
| 2. Link goes to email entry page. | ✅ **PASS** | `ForgotPasswordPage.tsx` is created and routed correctly. |
| 3. Submitting email triggers backend. | ✅ **PASS** | `forgotPassword` in `authService.ts` calls the backend endpoint. |
| 4. Email contains unique, time-limited link. | ✅ **PASS** | Backend generates a UUID token with a 1-hour expiry. Email sending is simulated. |
| 5. Reset page allows new password entry. | ✅ **PASS** | `ResetPasswordPage.tsx` has the required form fields. |
| 6. New password meets security requirements. | ⚠️ **CONCERNS** | No frontend or backend validation for password complexity (e.g., length, characters). |
| 7. Submitting updates password in DB. | ✅ **PASS** | `resetPassword` in `AuthService.java` handles this. |
| 8. Reset link/token is invalidated. | ✅ **PASS** | Token fields are nulled out after successful reset. |

#### 2. Code Review

**Frontend:**
*   **`ForgotPasswordPage.tsx`:** There is a typo `setEmail(e.g.value)` instead of `setEmail(e.target.value)`. This will cause a runtime error.
*   **General:** The code is clean and follows existing patterns. Error handling with `react-hot-toast` is a nice touch.

**Backend:**
*   **`AuthService.java`:** The logic is sound. The use of `ifPresent` for the `forgotPassword` flow is good practice to prevent user enumeration.
*   **Security:** The core security aspects (secure token, expiry, invalidation) are implemented correctly.
*   **Configuration:** The frontend URL for the reset link is hardcoded in the `println`. This should be a configurable property.

#### 3. Risk Assessment

*   **Low:** The lack of password complexity validation is a minor risk for this stage but should be addressed.
*   **Low:** The hardcoded frontend URL is a configuration risk but acceptable for local development.
*   **High:** The typo in `ForgotPasswordPage.tsx` will break the feature.

#### 4. Gate Decision: ⚠️ CONCERNS

The implementation is mostly solid, but the typo in the frontend is a blocker. Additionally, the lack of password complexity validation and the hardcoded URL should be addressed.

**Recommendations:**
1.  **[BLOCKER]** Fix the typo in `ForgotPasswordPage.tsx`.
2.  **[HIGH]** Add password complexity validation on both the frontend and backend.
3.  **[MEDIUM]** Externalize the frontend URL configuration in the backend.

---
### Final QA Review (2025-11-06)

All previously identified issues have been re-verified against the current codebase and are now resolved.
- **Typo:** The typo in `ForgotPasswordPage.tsx` is not present.
- **Password Validation:** Robust complexity validation is now implemented on both the frontend (`ResetPasswordPage.tsx`) and the backend (`ResetPasswordRequest.java`).
- **Configuration:** The hardcoded frontend URL has been replaced with a configurable property in `AuthService.java`.

#### Final Gate Decision: ✅ PASS

The story now meets all functional and quality requirements.

