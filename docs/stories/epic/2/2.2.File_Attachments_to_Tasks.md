# Story 2.2: File Attachments to Tasks

## Status
ready_for_QA

## Story
**As an** authenticated user,
**I want** to attach files to tasks via drag and drop,
**so that** I can provide relevant documents or resources for the task.

## Acceptance Criteria
1. The task detail view includes an area for file attachments.
2. Users can drag and drop files onto this area to upload them.
3. Uploaded files are associated with the task and stored securely.
4. Attached files are listed in the task detail view, with options to download them.
5. The system handles common file types (e.g., images, PDFs, documents).

## Tasks / Subtasks
- [x] Task 1 (Frontend - AC: 1, 4): Implement an `AttachmentsSection` component within the `TaskDetailsModal`.
    - [x] Subtask 1.1: Display existing attachments, showing file name and a download link/button.
- [x] Task 2 (Frontend - AC: 2, 5): Implement a drag-and-drop file upload zone.
    - [x] Subtask 2.1: On file drop, call an `uploadAttachmentToTask` method in the `taskService`.
    - [x] Subtask 2.2: Update the local state to display the new attachment immediately.
- [x] Task 3 (Backend - AC: 3, 5): Implement the `POST /api/tasks/{taskId}/attachments` endpoint for file uploads.
    - [x] Subtask 3.1: Create an `AttachmentService` to handle file storage and association with tasks.
    - [x] Subtask 3.2: Store the file in a designated local storage location (for MVP) and save its metadata (file name, URL, type) to the database.

## Dev Notes

### Frontend
- **Component:** An `AttachmentsSection` component will be needed within the `TaskDetailsModal`. A drag-and-drop library can be used to facilitate the upload UI. [Source: `docs/architecture/components.md`]
- **Data Flow:** After a file is uploaded, the list of attachments should be refreshed to show the new file. [Source: `docs/architecture/core-workflows.md`]
- **Implemented Files:**
    - `frontend/src/components/AttachmentsSection.tsx`
    - `frontend/src/components/TaskDetailsModal.tsx` (updated to include `AttachmentsSection`)
    - `frontend/src/types/index.ts` (added `Attachment` interface)
    - `frontend/src/services/taskService.ts` (added `uploadAttachmentToTask` and `fetchAttachmentsForTask`)

### Backend
- **Endpoint:** A new `POST /api/tasks/{taskId}/attachments` endpoint is required. This will be a multipart request. [Source: `docs/architecture/api-specification.md`]
- **Service Logic:** An `AttachmentService` will be responsible for handling file uploads and managing attachment metadata. [Source: `docs/architecture/backend-architecture.md`]
- **Data Model:** The `Attachment` entity will be used. It has a relationship with `Task`. [Source: `docs/architecture/data-models.md`]
- **File Storage:** For the MVP, files will be stored on the local filesystem. This will need to be replaced with a cloud storage solution (e.g., AWS S3, Azure Blob Storage) for production. [Source: `docs/architecture/tech-stack.md`]
- **Implemented Files:**
    - `backend/src/main/java/com/taskflow/model/Attachment.java`
    - `backend/src/main/java/com/taskflow/repository/AttachmentRepository.java`
    - `backend/src/main/java/com/taskflow/service/AttachmentService.java`
    - `backend/src/main/java/com/taskflow/controller/AttachmentController.java`
    - `backend/src/main/java/com/taskflow/dto/AttachmentDTO.java`
    - `backend/src/main/java/com/taskflow/model/Task.java` (updated to include `attachments` relationship)
    - `backend/src/main/resources/application.properties` (added `app.upload.dir`)

### Testing
- **Backend:** Integration tests for the `AttachmentController` (once created) and unit tests for the `AttachmentService` should be written, covering file upload and metadata persistence. [Source: `docs/architecture/testing-strategy.md`]
- **Frontend:** Component tests for the `AttachmentsSection` and integration tests for uploading and displaying attachments should be created. [Source: `docs/architecture/testing-strategy.md`]
- **Implemented Test Files:**
    - `backend/src/test/java/com/taskflow/service/AttachmentServiceTest.java`
    - `backend/src/test/java/com/taskflow/controller/AttachmentControllerIntegrationTest.java`

## Status
Approved

## Story
**As an** authenticated user,
**I want** to attach files to tasks via drag and drop,
**so that** I can provide relevant documents or resources for the task.

## Acceptance Criteria
1. The task detail view includes an area for file attachments.
2. Users can drag and drop files onto this area to upload them.
3. Uploaded files are associated with the task and stored securely.
4. Attached files are listed in the task detail view, with options to download them.
5. The system handles common file types (e.g., images, PDFs, documents).

## Tasks / Subtasks
- [x] Task 1 (Frontend - AC: 1, 4): Implement an `AttachmentsSection` component within the `TaskDetailsModal`.
    - [x] Subtask 1.1: Display existing attachments, showing file name and a download link/button.
- [x] Task 2 (Frontend - AC: 2, 5): Implement a drag-and-drop file upload zone.
    - [x] Subtask 2.1: On file drop, call an `uploadAttachmentToTask` method in the `taskService`.
    - [x] Subtask 2.2: Update the local state to display the new attachment immediately.
- [x] Task 3 (Backend - AC: 3, 5): Implement the `POST /api/tasks/{taskId}/attachments` endpoint for file uploads.
    - [x] Subtask 3.1: Create an `AttachmentService` to handle file storage and association with tasks.
    - [x] Subtask 3.2: Store the file in a designated local storage location (for MVP) and save its metadata (file name, URL, type) to the database.

## Dev Notes

### Frontend
- **Component:** An `AttachmentsSection` component will be needed within the `TaskDetailsModal`. A drag-and-drop library can be used to facilitate the upload UI. [Source: `docs/architecture/components.md`]
- **Data Flow:** After a file is uploaded, the list of attachments should be refreshed to show the new file. [Source: `docs/architecture/core-workflows.md`]
- **Implemented Files:**
    - `frontend/src/components/AttachmentsSection.tsx`
    - `frontend/src/components/TaskDetailsModal.tsx` (updated to include `AttachmentsSection`)
    - `frontend/src/types/index.ts` (added `Attachment` interface)
    - `frontend/src/services/taskService.ts` (added `uploadAttachmentToTask` and `fetchAttachmentsForTask`)

### Backend
- **Endpoint:** A new `POST /api/tasks/{taskId}/attachments` endpoint is required. This will be a multipart request. [Source: `docs/architecture/api-specification.md`]
- **Service Logic:** An `AttachmentService` will be responsible for handling file uploads and managing attachment metadata. [Source: `docs/architecture/backend-architecture.md`]
- **Data Model:** The `Attachment` entity will be used. It has a relationship with `Task`. [Source: `docs/architecture/data-models.md`]
- **File Storage:** For the MVP, files will be stored on the local filesystem. This will need to be replaced with a cloud storage solution (e.g., AWS S3, Azure Blob Storage) for production. [Source: `docs/architecture/tech-stack.md`]
- **Implemented Files:**
    - `backend/src/main/java/com/taskflow/model/Attachment.java`
    - `backend/src/main/java/com/taskflow/repository/AttachmentRepository.java`
    - `backend/src/main/java/com/taskflow/service/AttachmentService.java`
    - `backend/src/main/java/com/taskflow/controller/AttachmentController.java`
    - `backend/src/main/java/com/taskflow/dto/AttachmentDTO.java`
    - `backend/src/main/java/com/taskflow/model/Task.java` (updated to include `attachments` relationship)
    - `backend/src/main/resources/application.properties` (added `app.upload.dir`)

### Testing
- **Backend:** Integration tests for the `AttachmentController` (once created) and unit tests for the `AttachmentService` should be written, covering file upload and metadata persistence. [Source: `docs/architecture/testing-strategy.md`]
- **Frontend:** Component tests for the `AttachmentsSection` and integration tests for uploading and displaying attachments should be created. [Source: `docs/architecture/testing-strategy.md`]
- **Implemented Test Files:**
    - `backend/src/test/java/com/taskflow/service/AttachmentServiceTest.java`
    - `backend/src/test/java/com/taskflow/controller/AttachmentControllerIntegrationTest.java`
    - `frontend/src/components/__tests__/AttachmentsSection.test.tsx`

## QA Results

### Review Date: 2025-11-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The overall code quality is good. The implementation is clean, follows established patterns, and is well-tested. Both frontend and backend components are logically separated and adhere to their respective responsibilities.

### Refactoring Performed

- **File**: `frontend/src/types/index.ts`
  - **Change**: Updated the `Attachment` interface to align with the backend `AttachmentDTO`.
  - **Why**: To ensure type consistency between the frontend and backend, preventing potential runtime errors and improving developer experience.
  - **How**: Modified `name` to `fileName`, `type` to `fileType`, and added `id`, `taskId`, and `uploadedAt` fields.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] Refactored `Attachment` interface in `frontend/src/types/index.ts` for type consistency.

### Security Review

No immediate security concerns were identified. File storage is local for MVP, which is noted in the Dev Notes for future cloud migration.

### Performance Considerations

No immediate performance issues were identified. The current implementation for file upload and retrieval is efficient for the MVP scope.

### Files Modified During Review

- `frontend/src/types/index.ts` (Dev Agent should update File List)

### Gate Status

Gate: PASS → docs/qa/gates/2.2-file-attachments-to-tasks.yml
Risk profile: (Not generated for this review)
NFR assessment: (Not generated for this review)

### Recommended Status

✓ Ready for Done

